<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI X-Ray Simulator Pro | Ù…Ø­Ø§ÙƒÙŠ Ø§Ù„Ø£Ø´Ø¹Ø© Ø§Ù„Ø°ÙƒÙŠ</title>
    
    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js" crossorigin="anonymous"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Cairo:wght@400;700&family=Roboto:wght@400;700&display=swap');

        :root {
            --medical-cyan: #00acc1;
        }

        body {
            margin: 0;
            background-color: #050a0f;
            color: #e0f2f1;
            font-family: 'Cairo', 'Roboto', sans-serif;
            overflow: hidden;
            height: 100vh;
            user-select: none;
        }

        .medical-font { font-family: 'Orbitron', sans-serif; }

        #viewport {
            position: relative;
            width: 100%;
            height: 60vh;
            background: #000;
            overflow: hidden;
            border-bottom: 2px solid var(--medical-cyan);
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .crosshair-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20;
            pointer-events: none;
            display: none;
        }

        .guide-arrow {
            position: absolute;
            font-size: 2rem;
            color: #ff5252;
            transition: all 0.2s ease;
            opacity: 0;
        }

        .panel-bg {
            background: linear-gradient(180deg, #0a141d 0%, #050a0f 100%);
        }

        .mode-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 172, 193, 0.3);
            transition: all 0.3s;
        }

        .mode-btn.active {
            background: var(--medical-cyan);
            color: white;
            box-shadow: 0 0 15px rgba(0, 172, 193, 0.5);
        }

        #flash {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: white; opacity: 0; z-index: 100; pointer-events: none;
            transition: opacity 0.1s;
        }

        .scanner-line {
            position: absolute;
            width: 100%; height: 2px;
            background: rgba(0, 255, 255, 0.5);
            box-shadow: 0 0 10px #00ffff;
            animation: scan 3s linear infinite;
            display: none;
            z-index: 10;
        }

        @keyframes scan {
            0% { top: 0; }
            100% { top: 100%; }
        }

        .pulse { animation: pulse-red 2s infinite; }
        @keyframes pulse-red {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(255, 82, 82, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(255, 82, 82, 0); }
        }

        #lang-toggle {
            position: absolute;
            top: 1rem;
            left: 50%;
            transform: translateX(-50%);
            z-index: 60;
            background: rgba(0, 172, 193, 0.2);
            border: 1px solid var(--medical-cyan);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            backdrop-filter: blur(4px);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--medical-cyan); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="notification-area" class="fixed top-20 left-1/2 -translate-x-1/2 z-[100] w-72 pointer-events-none"></div>

    <button id="lang-toggle" onclick="toggleLanguage()">English</button>

    <div id="viewport">
        <div id="flash"></div>
        <div class="scanner-line" id="scanner"></div>
        
        <video id="webcam" autoplay playsinline muted></video>

        <!-- Initial Startup Screen -->
        <div id="startup-screen" class="absolute inset-0 flex flex-col items-center justify-center z-50 bg-slate-900">
            <div class="mb-6 text-cyan-400 text-6xl medical-font text-center px-4">AI X-RAY</div>
            <p id="txt-subtitle" class="text-gray-400 mb-8 text-center px-6">Ù†Ø¸Ø§Ù… Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø¹ÙŠ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ</p>
            <button id="btn-boot" onclick="bootSystem()" class="bg-cyan-600 hover:bg-cyan-500 text-white px-10 py-4 rounded-full font-bold transition-all transform hover:scale-105 shadow-lg">
                ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… (BOOT)
            </button>
        </div>

        <!-- AI Guidance Overlay -->
        <div id="ai-hud" class="absolute top-4 left-4 right-4 flex justify-between items-start pointer-events-none hidden">
            <div class="bg-black/60 border border-cyan-500/50 p-3 rounded text-[10px] sm:text-xs medical-font">
                <div class="text-cyan-400"><span id="lbl-detection">DETECTION</span>: <span id="detection-status">SEARCHING...</span></div>
                <div class="text-gray-400">FPS: <span id="fps-val">0</span></div>
            </div>
            <div id="central-msg" class="bg-black/80 border-2 border-yellow-500 text-yellow-500 px-4 py-2 rounded-full font-bold text-sm sm:text-lg shadow-lg max-w-[50%] text-center">
                Ø¶Ø¹ Ø§Ù„Ø¹Ø¶Ùˆ ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ²
            </div>
            <div class="bg-black/60 border border-cyan-500/50 p-3 rounded text-right text-[10px] sm:text-xs medical-font">
                <div class="text-cyan-400">SID: 100 cm</div>
                <div class="text-gray-400">FILTER: AL 2.5mm</div>
            </div>
        </div>

        <!-- Crosshair & Arrows -->
        <div class="crosshair-container" id="crosshair">
            <div id="arrow-up" class="guide-arrow" style="top: -60px; left: 50%; transform: translateX(-50%);">â–²</div>
            <div id="arrow-down" class="guide-arrow" style="bottom: -60px; left: 50%; transform: translateX(-50%);">â–¼</div>
            <div id="arrow-left" class="guide-arrow" style="left: -60px; top: 50%; transform: translateY(-50%);">â—€</div>
            <div id="arrow-right" class="guide-arrow" style="right: -60px; top: 50%; transform: translateY(-50%);">â–¶</div>

            <div class="relative w-24 h-24 sm:w-32 sm:h-32 flex items-center justify-center">
                <div class="absolute w-full h-0.5 bg-red-500/60"></div>
                <div class="absolute h-full w-0.5 bg-red-500/60"></div>
                <div class="w-4 h-4 rounded-full border-2 border-yellow-400 bg-yellow-400/20 shadow-[0_0_10px_#facc15]"></div>
            </div>
        </div>

        <button onclick="toggleCamera()" id="flip-btn" class="absolute bottom-4 left-4 bg-white/10 hover:bg-white/20 p-3 rounded-full hidden z-30 backdrop-blur-md">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-white"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
        </button>
    </div>

    <!-- Controls Panel -->
    <div class="h-[40vh] panel-bg p-4 flex flex-col overflow-hidden">
        <div class="grid grid-cols-3 gap-2 mb-4 shrink-0">
            <div class="bg-black/40 p-2 rounded border border-white/5 text-center">
                <span class="block text-[10px] text-gray-500 medical-font uppercase">kVp</span>
                <span class="text-lg sm:text-xl text-cyan-400 medical-font font-bold" id="val-kvp">65</span>
            </div>
            <div class="bg-black/40 p-2 rounded border border-white/5 text-center">
                <span class="block text-[10px] text-gray-500 medical-font uppercase">mAs</span>
                <span class="text-lg sm:text-xl text-cyan-400 medical-font font-bold" id="val-mas">4.5</span>
            </div>
            <div class="bg-black/40 p-2 rounded border border-white/5 text-center">
                <span class="block text-[10px] text-gray-500 medical-font uppercase">AEC</span>
                <span class="text-lg sm:text-xl text-orange-400 medical-font font-bold" id="val-aec">OFF</span>
            </div>
        </div>

        <!-- Mode Selection -->
        <div id="modes-list" class="flex gap-2 mb-4 overflow-x-auto pb-2 shrink-0 no-scrollbar">
            <!-- Populated via JS -->
        </div>

        <!-- Main Action Buttons -->
        <div class="flex gap-4 mt-auto mb-2 shrink-0">
            <button id="prep-btn" class="flex-1 bg-yellow-600/20 border border-yellow-600 text-yellow-600 py-3 sm:py-4 rounded-xl font-bold active:bg-yellow-600 active:text-black transition-colors uppercase text-sm">
                PREP
            </button>
            <button id="expose-btn" onclick="triggerExposure()" class="flex-1 bg-red-600/20 border border-red-600 text-red-600 py-3 sm:py-4 rounded-xl font-bold opacity-50 cursor-not-allowed uppercase text-sm">
                EXPOSE
            </button>
        </div>

        <div class="text-[10px] text-gray-600 text-center uppercase tracking-widest medical-font">
            Radiology Simulation Interface v2.5 Pro
        </div>
    </div>

    <!-- AI Chat Tutor Interface -->
    <button onclick="toggleChat()" class="fixed bottom-6 right-6 bg-cyan-600 hover:bg-cyan-500 text-white p-4 rounded-full z-40 shadow-[0_0_15px_rgba(0,172,193,0.5)] transition-transform transform hover:scale-110">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
    </button>

    <div id="chat-panel" class="hidden fixed bottom-24 right-6 w-80 max-w-[90vw] h-[400px] bg-gray-900 border border-cyan-500 rounded-xl z-50 flex-col shadow-2xl overflow-hidden backdrop-blur-lg">
        <div class="bg-cyan-900/90 p-3 flex justify-between items-center text-white border-b border-cyan-500/50">
            <span id="lbl-chat-title" class="font-bold text-sm medical-font">AI Tutor</span>
            <button onclick="toggleChat()" class="hover:text-red-400 font-bold px-2 text-lg">âœ•</button>
        </div>
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-3 text-sm bg-black/60 scroll-smooth">
            <!-- Messages render here -->
        </div>
        <div class="p-3 border-t border-cyan-900 bg-gray-900 flex gap-2">
            <input type="text" id="chat-input" class="flex-1 bg-black text-white rounded-lg px-3 py-2 outline-none border border-gray-700 focus:border-cyan-500 text-sm transition-colors" placeholder="Ask about positioning...">
            <button onclick="sendChatMessage()" id="btn-chat-send" class="bg-cyan-600 hover:bg-cyan-500 px-4 py-2 rounded-lg text-white font-bold text-sm transition-colors shadow-lg">Send</button>
        </div>
    </div>

    <script>
        const video = document.getElementById('webcam');
        const crosshair = document.getElementById('crosshair');
        const startup = document.getElementById('startup-screen');
        const aiHud = document.getElementById('ai-hud');
        const centralMsg = document.getElementById('central-msg');
        const detectionStatus = document.getElementById('detection-status');
        const flash = document.getElementById('flash');
        const scanner = document.getElementById('scanner');

        let currentMode = 'hand';
        let aiEnabled = false;
        let isProcessing = false;
        let facingMode = "environment";
        let lastFrameTime = Date.now();
        let currentLang = 'ar';
        const apiKey = ""; 

        const i18n = {
            ar: {
                toggle: "English",
                subtitle: "Ù†Ø¸Ø§Ù… Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø¹ÙŠ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ",
                boot: "ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… (BOOT)",
                detection: "Ø§Ù„Ø§Ø³ØªØ´Ø¹Ø§Ø±",
                searching: "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...",
                locked: "ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª",
                initial_msg: "Ø¶Ø¹ Ø§Ù„Ø¹Ø¶Ùˆ ÙÙŠ Ø§Ù„Ù…Ø±ÙƒØ²",
                look_patient: "Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø±ÙŠØ¶...",
                move_center: "Ø­Ø±Ùƒ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù„Ù„ØªÙˆØ³ÙŠØ·",
                success_capture: "ğŸ“¸ ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­!",
                prep: "ØªØ¬Ù‡ÙŠØ² (PREP)",
                expose: "ØªØµÙˆÙŠØ± (EXPOSE)",
                aec: "Ù…ØºÙ„Ù‚",
                cam_err: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„.",
                modes: {
                    hand: "ğŸ–ï¸ ÙŠØ¯ (Hand)",
                    chest: "ğŸ« ØµØ¯Ø± (Chest)",
                    foot: "ğŸ‘£ Ù‚Ø¯Ù… (Foot)",
                    knee: "ğŸ¦´ Ø±ÙƒØ¨Ø© (Knee)"
                },
                success_msgs: {
                    hand: "Ø§Ù„Ø³Ù†ØªØ± Ø¹Ù„Ù‰ Ù…ÙØµÙ„ MCP",
                    chest: "Ø§Ù„Ø³Ù†ØªØ± Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ T7",
                    foot: "Ø§Ù„Ø³Ù†ØªØ± Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø´Ø· Ø§Ù„Ø«Ø§Ù„Ø«",
                    knee: "Ø§Ù„Ø³Ù†ØªØ± Ø¹Ù„Ù‰ Ù…ÙØµÙ„ Ø§Ù„Ø±ÙƒØ¨Ø©"
                },
                chat_title: "Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ø°ÙƒÙŠ (AI Tutor)",
                chat_placeholder: "Ø§Ø³Ø£Ù„ Ø¹Ù† ÙˆØ¶Ø¹ÙŠØ§Øª Ø§Ù„ØªØµÙˆÙŠØ±...",
                chat_send: "Ø¥Ø±Ø³Ø§Ù„",
                chat_welcome: "Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ Ù…Ø³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒÙŠ Ù„ØªØ¹Ù„Ù… Ø§Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø¹ÙŠ. Ù‡Ù„ Ù„Ø¯ÙŠÙƒ Ø£ÙŠ Ø³Ø¤Ø§Ù„ Ø­ÙˆÙ„ ÙˆØ¶Ø¹ÙŠØ§Øª Ø§Ù„ØªØµÙˆÙŠØ±ØŒ Ø¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªØ¹Ø±ÙŠØ¶ØŒ Ø£Ùˆ Ø§Ù„ØªØ´Ø±ÙŠØ­ØŸ"
            },
            en: {
                toggle: "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
                subtitle: "AI-Powered Radiological Guidance Simulator",
                boot: "BOOT SYSTEM",
                detection: "DETECTION",
                searching: "SEARCHING...",
                locked: "LOCKED",
                initial_msg: "Place limb in center",
                look_patient: "Looking for patient...",
                move_center: "Move camera to center",
                success_capture: "ğŸ“¸ Capture Successful!",
                prep: "PREP",
                expose: "EXPOSE",
                aec: "OFF",
                cam_err: "Camera Error. Please grant permissions.",
                modes: {
                    hand: "ğŸ–ï¸ Hand AP",
                    chest: "ğŸ« Chest PA",
                    foot: "ğŸ‘£ Foot AP",
                    knee: "ğŸ¦´ Knee LAT"
                },
                success_msgs: {
                    hand: "CENTRAL RAY ON MCP",
                    chest: "CENTRAL RAY ON T7",
                    foot: "CENTRAL RAY ON 3RD METATARSAL",
                    knee: "CENTRAL RAY ON KNEE JOINT"
                },
                chat_title: "AI Radiology Tutor",
                chat_placeholder: "Ask about positioning...",
                chat_send: "Send",
                chat_welcome: "Hello! I'm your AI Radiology Tutor. Do you have any questions about positioning, exposure factors, or anatomy?"
            }
        };

        // Utility for notifications instead of alert()
        function showNotification(msg, type = 'error') {
            const area = document.getElementById('notification-area');
            const notif = document.createElement('div');
            notif.className = `mb-2 p-4 rounded-lg text-white font-bold text-center shadow-2xl transition-all opacity-0 translate-y-4 ${type === 'error' ? 'bg-red-600' : 'bg-cyan-600'}`;
            notif.innerText = msg;
            area.appendChild(notif);
            setTimeout(() => { notif.classList.remove('opacity-0', 'translate-y-4'); }, 10);
            setTimeout(() => {
                notif.classList.add('opacity-0', 'translate-y-4');
                setTimeout(() => notif.remove(), 500);
            }, 3000);
        }

        // --- MediaPipe Init ---
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5 });

        const pose = new Pose({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`});
        pose.setOptions({ modelComplexity: 1, minDetectionConfidence: 0.5 });

        function updateUIStrings() {
            const lang = i18n[currentLang];
            document.documentElement.dir = currentLang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.lang = currentLang;
            
            document.getElementById('lang-toggle').innerText = lang.toggle;
            document.getElementById('txt-subtitle').innerText = lang.subtitle;
            document.getElementById('btn-boot').innerText = lang.boot;
            document.getElementById('lbl-detection').innerText = lang.detection;
            document.getElementById('val-aec').innerText = lang.aec;
            document.getElementById('prep-btn').innerText = lang.prep;
            document.getElementById('expose-btn').innerText = lang.expose;
            
            document.getElementById('lbl-chat-title').innerText = lang.chat_title;
            document.getElementById('chat-input').placeholder = lang.chat_placeholder;
            document.getElementById('btn-chat-send').innerText = lang.chat_send;
            
            if (!aiEnabled) centralMsg.innerText = lang.initial_msg;
            
            const list = document.getElementById('modes-list');
            list.innerHTML = '';
            Object.keys(lang.modes).forEach(key => {
                const btn = document.createElement('button');
                btn.id = 'm-' + key;
                btn.className = `mode-btn flex-shrink-0 px-5 py-3 rounded-lg text-sm font-bold ${currentMode === key ? 'active' : ''}`;
                btn.innerText = lang.modes[key];
                btn.onclick = () => setMode(key);
                list.appendChild(btn);
            });
        }

        function toggleLanguage() {
            currentLang = currentLang === 'ar' ? 'en' : 'ar';
            updateUIStrings();
        }

        function bootSystem() {
            startup.innerHTML = `<div class="text-cyan-400 medical-font text-2xl animate-pulse uppercase">${currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...' : 'LOADING SYSTEM...'}</div>`;
            setTimeout(startCamera, 1000);
        }

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: facingMode, width: { ideal: 1280 }, height: { ideal: 720 } }
                });
                video.srcObject = stream;
                video.style.display = 'block';
                video.style.transform = (facingMode === "user") ? "scaleX(-1)" : "scaleX(1)";
                
                video.onloadedmetadata = () => {
                    startup.style.display = 'none';
                    aiHud.classList.remove('hidden');
                    crosshair.style.display = 'block';
                    document.getElementById('flip-btn').classList.remove('hidden');
                    scanner.style.display = 'block';
                    aiEnabled = true;
                    runDetection();
                };
            } catch (err) {
                showNotification(i18n[currentLang].cam_err);
                startup.innerHTML = `<button onclick="startCamera()" class="text-red-500 font-bold underline">RETRY ACCESS</button>`;
            }
        }

        function toggleCamera() {
            aiEnabled = false;
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            facingMode = facingMode === "environment" ? "user" : "environment";
            startCamera();
        }

        function setMode(mode) {
            currentMode = mode;
            updateUIStrings();
            const specs = {
                hand: {kv: 55, mas: 2.0},
                chest: {kv: 110, mas: 4.0},
                foot: {kv: 60, mas: 2.5},
                knee: {kv: 70, mas: 8.0}
            };
            document.getElementById('val-kvp').innerText = specs[mode].kv;
            document.getElementById('val-mas').innerText = specs[mode].mas;
            centralMsg.innerText = i18n[currentLang].searching;
        }

        // --- Improved Detection Result Handling ---

        hands.onResults(results => {
            if (!aiEnabled) return;
            if (currentMode === 'hand' || currentMode === 'foot') {
                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    // Center on MCP joint of middle finger (Landmark 9)
                    const center = results.multiHandLandmarks[0][9]; 
                    handleGuidance(center.x, center.y, i18n[currentLang].success_msgs[currentMode]);
                } else {
                    lostTarget();
                }
            }
        });

        pose.onResults(results => {
            if (!aiEnabled) return;
            if (currentMode === 'chest') {
                if (results.poseLandmarks) {
                    // Chest centering: Average of shoulders (11, 12) + offset for T7 mid-thoracic region
                    const ls = results.poseLandmarks[11];
                    const rs = results.poseLandmarks[12];
                    const centerX = (ls.x + rs.x) / 2;
                    const centerY = (ls.y + rs.y) / 2 + 0.18; // Adjusted for T7
                    handleGuidance(centerX, centerY, i18n[currentLang].success_msgs[currentMode]);
                } else {
                    lostTarget();
                }
            } else if (currentMode === 'knee') {
                if (results.poseLandmarks) {
                    // Knee centering: Use the average position of detectable knees (25, 26)
                    const lk = results.poseLandmarks[25];
                    const rk = results.poseLandmarks[26];
                    
                    // Logic: If both are visible, center between them. If one is dominant, center on that.
                    let targetX, targetY;
                    if (lk.visibility > 0.5 && rk.visibility > 0.5) {
                        targetX = (lk.x + rk.x) / 2;
                        targetY = (lk.y + rk.y) / 2;
                    } else if (lk.visibility > 0.5) {
                        targetX = lk.x; targetY = lk.y;
                    } else if (rk.visibility > 0.5) {
                        targetX = rk.x; targetY = rk.y;
                    } else {
                        lostTarget();
                        return;
                    }
                    handleGuidance(targetX, targetY, i18n[currentLang].success_msgs[currentMode]);
                } else {
                    lostTarget();
                }
            }
        });

        function handleGuidance(x, y, successMsg) {
            detectionStatus.innerText = i18n[currentLang].locked;
            detectionStatus.className = "text-green-400";
            
            // Normalize coordinates for the 0.5 center point
            const dx = x - 0.5;
            const dy = y - 0.5;
            
            // Tolerance logic: Slightly larger for mobile/pose detection, tighter for hands
            const tol = (currentMode === 'chest' || currentMode === 'knee') ? 0.09 : 0.07;

            document.querySelectorAll('.guide-arrow').forEach(a => a.style.opacity = 0);

            if (Math.abs(dx) < tol && Math.abs(dy) < tol) {
                centralMsg.innerText = "âœ… " + successMsg;
                centralMsg.className = "bg-green-600 text-white px-6 py-2 rounded-full font-bold shadow-lg text-sm sm:text-lg border-2 border-white/20";
                enableExpose(true);
            } else {
                centralMsg.innerText = i18n[currentLang].move_center;
                centralMsg.className = "bg-black/80 border-2 border-yellow-500 text-yellow-500 px-6 py-2 rounded-full font-bold text-sm sm:text-lg";
                enableExpose(false);
                
                // Directional Arrows Logic
                if (dy < -tol) document.getElementById('arrow-up').style.opacity = 1;
                if (dy > tol) document.getElementById('arrow-down').style.opacity = 1;
                
                const factor = (facingMode === "user") ? -1 : 1;
                if (dx * factor < -tol) document.getElementById(factor === 1 ? 'arrow-left' : 'arrow-right').style.opacity = 1;
                if (dx * factor > tol) document.getElementById(factor === 1 ? 'arrow-right' : 'arrow-left').style.opacity = 1;
            }
        }

        function lostTarget() {
            detectionStatus.innerText = i18n[currentLang].searching;
            detectionStatus.className = "text-yellow-400";
            centralMsg.innerText = i18n[currentLang].look_patient;
            document.querySelectorAll('.guide-arrow').forEach(a => a.style.opacity = 0);
            enableExpose(false);
        }

        async function runDetection() {
            if (!aiEnabled || isProcessing) {
                requestAnimationFrame(runDetection);
                return;
            }
            
            if (video.readyState >= 2) {
                isProcessing = true;
                try {
                    if (currentMode === 'hand' || currentMode === 'foot') {
                        await hands.send({image: video});
                    } else {
                        await pose.send({image: video});
                    }
                } catch (err) {
                    console.debug("Frame skip");
                } finally {
                    isProcessing = false;
                }
            }

            const now = Date.now();
            document.getElementById('fps-val').innerText = Math.round(1000 / (now - lastFrameTime));
            lastFrameTime = now;
            requestAnimationFrame(runDetection);
        }

        function enableExpose(status) {
            const btn = document.getElementById('expose-btn');
            if (status) {
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
                btn.classList.add('bg-red-600', 'text-white', 'pulse');
            } else {
                btn.classList.add('opacity-50', 'cursor-not-allowed');
                btn.classList.remove('bg-red-600', 'text-white', 'pulse');
            }
        }

        function triggerExposure() {
            if (document.getElementById('expose-btn').classList.contains('cursor-not-allowed')) return;
            flash.style.opacity = 1;
            setTimeout(() => { flash.style.opacity = 0; }, 150);
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
            
            const oldMsg = centralMsg.innerText;
            centralMsg.innerText = i18n[currentLang].success_capture;
            showNotification(i18n[currentLang].success_capture, 'success');
            
            setTimeout(() => { 
                if (aiEnabled) centralMsg.innerText = oldMsg; 
            }, 2000);
        }

        // --- AI Chat Logic with Backoff ---
        let chatInitialized = false;

        function toggleChat() {
            const panel = document.getElementById('chat-panel');
            panel.classList.toggle('hidden');
            panel.classList.toggle('flex');
            
            if (!chatInitialized) {
                appendMessage(i18n[currentLang].chat_welcome, 'ai');
                chatInitialized = true;
            }
        }

        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendChatMessage();
        });

        async function fetchWithBackoff(url, options, maxRetries = 5) {
            let delay = 1000;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return await response.json();
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                }
                await new Promise(res => setTimeout(res, delay));
                delay *= 2;
            }
            throw new Error("API Max Retries Exceeded");
        }

        async function sendChatMessage() {
            const inputEl = document.getElementById('chat-input');
            const text = inputEl.value.trim();
            if (!text) return;

            appendMessage(text, 'user');
            inputEl.value = '';
            
            const loadingId = appendMessage(currentLang === 'ar' ? "ÙŠÙÙƒØ±..." : "Thinking...", 'ai');

            const sysPrompt = currentLang === 'ar' 
                ? "Ø£Ù†Øª Ø®Ø¨ÙŠØ± ÙÙŠ Ø§Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø¹ÙŠ (Ø£Ø´Ø¹Ø© Ø¥ÙƒØ³) ÙˆØªØ¹Ù…Ù„ ÙƒÙ…Ø¹Ù„Ù… Ù„Ø·Ø§Ù„Ø¨ Ø·Ø¨. Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…ØªØ¹Ù„Ù‚Ø© Ø¨ÙˆØ¶Ø¹ÙŠØ§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰ØŒ Ø¹Ù„Ù… Ø§Ù„ØªØ´Ø±ÙŠØ­ØŒ ÙˆØ¹ÙˆØ§Ù…Ù„ Ø§Ù„ØªØ¹Ø±ÙŠØ¶ Ø¨Ø§Ø®ØªØµØ§Ø± ÙˆØ¹Ù„Ù…ÙŠØ©."
                : "You are an expert radiographer tutoring a medical student. Answer questions about patient positioning, anatomy, and exposure factors concisely and scientifically.";

            try {
                const payload = {
                    contents: [{ parts: [{ text: text }] }],
                    systemInstruction: { parts: [{ text: sysPrompt }] }
                };

                const data = await fetchWithBackoff(
                    `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
                    {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    }
                );

                const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || (currentLang === 'ar' ? "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ù… Ø£ÙÙ‡Ù…." : "Sorry, I couldn't understand.");
                updateMessage(loadingId, aiResponse);
            } catch (error) {
                updateMessage(loadingId, currentLang === 'ar' ? "Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„." : "Connection error. Please try again later.");
            }
        }

        function appendMessage(text, sender) {
            const chatBox = document.getElementById('chat-messages');
            const msgDiv = document.createElement('div');
            const msgId = 'msg-' + Date.now();
            msgDiv.id = msgId;
            
            const isRTL = currentLang === 'ar';
            
            msgDiv.className = `p-3 rounded-xl max-w-[85%] text-[13px] leading-relaxed shadow-md transition-all duration-300 ${
                sender === 'user' 
                ? `bg-cyan-700 text-white self-end ${isRTL ? 'rounded-tl-none' : 'rounded-tr-none'}` 
                : `bg-gray-800 border border-gray-700 text-gray-200 self-start ${isRTL ? 'rounded-tr-none' : 'rounded-tl-none'}`
            }`;
            msgDiv.innerText = text;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
            return msgId;
        }

        function updateMessage(id, text) {
            const msgDiv = document.getElementById(id);
            if (msgDiv) {
                msgDiv.innerText = text;
                const chatBox = document.getElementById('chat-messages');
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        }

        // Init
        updateUIStrings();
    </script>
</body>
</html>
